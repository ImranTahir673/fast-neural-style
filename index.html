<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Transform your photos into stunning artwork using deep learning neural style transfer">
    <title>Neural Style Transfer - AI Art Generator</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Neural Style Transfer</h1>
            <p>Transform your photos into stunning artwork with AI-powered style transfer</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-2-col">
            <!-- Left Panel: Upload & Style Selection -->
            <div class="card">
                <h2 class="section-title">1. Upload Your Image</h2>
                
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png" />
                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="upload-text">Drop your image here</p>
                        <p class="upload-subtext">or click to browse (JPG, PNG)</p>
                    </div>
                    <img id="inputPreview" class="preview-image hidden" alt="Input Preview" />
                </div>

                <div id="errorContainer"></div>

                <!-- Style Selection -->
                <div style="margin-top: 2rem;">
                    <h2 class="section-title">2. Choose Your Style</h2>
                    <div class="styles-grid">
                        {% for model in models %}
                        <label class="style-option" data-style="{{ model }}">
                            <input type="radio" name="style" value="{{ model }}" {% if loop.first %}checked{% endif %} />
                            <img src="/static/previews/{{ model.replace('.pth', '_preview.jpg') }}" 
                                 alt="{{ model.replace('.pth', '').replace('_', ' ').title() }}" 
                                 class="style-preview-img"
                                 onerror="this.src='/images/content/chicago.jpg'" />
                            <div class="style-name">{{ model.replace('.pth', '').replace('_', ' ') }}</div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-primary btn-full" id="generateBtn" style="margin-top: 2rem;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Styled Image
                </button>
            </div>

            <!-- Right Panel: Output -->
            <div class="card">
                <h2 class="section-title">3. Your Stylized Result</h2>
                
                <div class="output-container">
                    <!-- Placeholder -->
                    <div class="output-placeholder" id="outputPlaceholder">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p>Your styled artwork will appear here</p>
                    </div>

                    <!-- Loading Overlay -->
                    <div class="loading-overlay hidden" id="loadingOverlay">
                        <div class="spinner"></div>
                        <p class="loading-text">Creating your masterpiece...</p>
                    </div>

                    <!-- Result -->
                    <div class="result-wrapper hidden" id="resultWrapper">
                        <img id="resultImage" class="result-image" alt="Styled Result" />
                        <a id="downloadLink" href="#" download="styled_artwork.jpg" class="download-btn">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="display:inline-block;margin-right:4px;">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const imageInput = document.getElementById('imageInput');
        const uploadZone = document.getElementById('uploadZone');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const inputPreview = document.getElementById('inputPreview');
        const generateBtn = document.getElementById('generateBtn');
        const styleOptions = document.querySelectorAll('.style-option');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultWrapper = document.getElementById('resultWrapper');
        const resultImage = document.getElementById('resultImage');
        const downloadLink = document.getElementById('downloadLink');
        const errorContainer = document.getElementById('errorContainer');

        // File Upload Handling
        imageInput.addEventListener('change', handleFileSelect);
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && isValidFile(file)) {
                imageInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        function isValidFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            return validTypes.includes(file.type);
        }

        function handleFileSelect() {
            const file = imageInput.files[0];
            if (!file) return;

            if (!isValidFile(file)) {
                showError('Please upload a valid image file (JPG or PNG)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                inputPreview.src = e.target.result;
                inputPreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                clearError();
            };
            reader.readAsDataURL(file);
        }

        // Style Selection
        styleOptions.forEach(option => {
            option.addEventListener('click', () => {
                styleOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Initialize first style as selected
        if (styleOptions.length > 0) {
            styleOptions[0].classList.add('selected');
        }

        // Generate Styled Image
        generateBtn.addEventListener('click', async () => {
            if (!imageInput.files.length) {
                showError('Please select an image first!');
                return;
            }

            const selectedStyle = document.querySelector('input[name="style"]:checked');
            if (!selectedStyle) {
                showError('Please select a style!');
                return;
            }

            clearError();
            
            const formData = new FormData();
            formData.append('content_image', imageInput.files[0]);
            formData.append('style_model', selectedStyle.value);

            // UI State: Loading
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div> Stylizing...';
            outputPlaceholder.classList.add('hidden');
            resultWrapper.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/stylize', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Style transfer failed');
                }

                const data = await response.json();
                
                // Display result
                resultImage.src = data.output_url + '?t=' + new Date().getTime(); // Cache busting
                downloadLink.href = data.output_url;
                downloadLink.download = 'styled_' + imageInput.files[0].name;
                
                loadingOverlay.classList.add('hidden');
                resultWrapper.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
                outputPlaceholder.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
            } finally {
                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Styled Image
                `;
            }
        });

        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            errorContainer.innerHTML = '';
        }
    </script>
</body>
</html>
